# Automatically generated by hassfest.
#
# To update, run python3 -m script.hassfest -p docker
ARG BUILD_FROM
FROM ${BUILD_FROM}

LABEL \
    io.hass.type="core" \
    org.opencontainers.image.authors="EXOME Authors" \
    org.opencontainers.image.description="EXOME - Open-source home automation platform running on Python 3" \
    org.opencontainers.image.licenses="Apache-2.0" \
    org.opencontainers.image.title="EXOME"

# Synchronize with homeassistant/core.py:async_stop
ENV \
    S6_SERVICES_GRACETIME=240000 \
    UV_SYSTEM_PYTHON=true \
    UV_NO_CACHE=true

# EXOME S6-Overlay
COPY rootfs /

# Add go2rtc binary
COPY --from=ghcr.io/alexxit/go2rtc@sha256:f394f6329f5389a4c9a7fc54b09fdec9621bbb78bf7a672b973440bbdfb02241 /usr/local/bin/go2rtc /bin/go2rtc

RUN \
    # Verify go2rtc can be executed
    go2rtc --version \
    # Install uv
    && pip3 install uv==0.9.17

WORKDIR /usr/src

## Setup EXOME Core dependencies
COPY requirements.txt homeassistant/
COPY homeassistant/package_constraints.txt homeassistant/homeassistant/
RUN \
    uv pip install \
    --no-build \
    -r homeassistant/requirements.txt

COPY requirements_all.txt home_assistant_frontend-* home_assistant_intents-* homeassistant/
RUN \
    if ls homeassistant/home_assistant_*.whl 1> /dev/null 2>&1; then \
    uv pip install homeassistant/home_assistant_*.whl; \
    fi \
    && uv pip install \
    --no-build \
    -r homeassistant/requirements_all.txt

## Setup EXOME Core
COPY . homeassistant/
RUN \
    uv pip install \
    -e ./homeassistant \
    && python3 -m compileall \
    homeassistant/homeassistant

WORKDIR /config
